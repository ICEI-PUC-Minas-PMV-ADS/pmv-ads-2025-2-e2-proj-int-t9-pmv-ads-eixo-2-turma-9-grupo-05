@model EcoTrash.Models.Pesagem

@{
    ViewData["Title"] = "Cadastrar Pesagem";
}

<div class="container mt-5">
    <h1 class="mb-3">Cadastrar Pesagem</h1>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <form asp-action="Create" id="form-pesagem">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <div class="mb-3">
            <label asp-for="Peso" class="form-label"></label>
            <input asp-for="Peso" type="number" step="0.01" class="form-control"
                   placeholder="Ex: 2.5" required />
            <span asp-validation-for="Peso" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="TipoMaterial" class="form-label"></label>
            <input asp-for="TipoMaterial" class="form-control"
                   placeholder="Ex: Plástico, Metal, Papel..." required />
            <span asp-validation-for="TipoMaterial" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label class="form-label">Localização</label>
            <div class="row g-2">
                <div class="col-12 col-md-4">
                    <select id="estado" class="form-select" required>
                        <option value="">Estado (UF)</option>
                    </select>
                </div>
                <div class="col-12 col-md-8">
                    <select id="cidade" class="form-select" required disabled>
                        <option value="">Cidade</option>
                    </select>
                </div>
            </div>
            <input type="hidden" asp-for="Localizacao" id="localizacaoCompleta" />
            <span asp-validation-for="Localizacao" class="text-danger"></span>
            <div class="form-text">A cidade será habilitada após selecionar o estado.</div>
        </div>

        <button type="submit" class="btn btn-success">Salvar</button>
        <a asp-action="Index" class="btn btn-secondary">Cancelar</a>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('form-pesagem');
            const selEstado = document.getElementById('estado');
            const selCidade = document.getElementById('cidade');
            const localizacaoCompleta = document.getElementById('localizacaoCompleta');

            async function carregarEstados() {
                selEstado.innerHTML = '<option value="">Estado (UF)</option>';
                try {
                    const resp = await fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome');
                    const data = await resp.json();
                    data.forEach(e => {
                        const opt = document.createElement('option');
                        opt.value = e.sigla;
                        opt.textContent = e.sigla + ' - ' + e.nome;
                        selEstado.appendChild(opt);
                    });
                } catch (error) {
                    console.error('Erro ao carregar estados:', error);
                }
            }

            async function carregarCidades(uf) {
                selCidade.disabled = !uf;
                selCidade.innerHTML = '<option value="">Cidade</option>';
                localizacaoCompleta.value = '';

                if (!uf) return;

                try {
                    const resp = await fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados/' + uf + '/municipios');
                    const data = await resp.json();
                    data.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.nome;
                        opt.textContent = c.nome;
                        selCidade.appendChild(opt);
                    });
                    selCidade.disabled = false;
                } catch (error) {
                    console.error('Erro ao carregar cidades:', error);
                }
            }

            function atualizarLocalizacao() {
                const uf = selEstado.value?.trim();
                const cidade = selCidade.value?.trim();

                if (uf && cidade) {
                    localizacaoCompleta.value = uf + ' - ' + cidade;
                } else {
                    localizacaoCompleta.value = '';
                }
            }

            selEstado.addEventListener('change', function() {
                carregarCidades(this.value);
                atualizarLocalizacao();
            });

            selCidade.addEventListener('change', atualizarLocalizacao);

            form.addEventListener('submit', function(e) {
                const uf = selEstado.value?.trim();
                const cidade = selCidade.value?.trim();

                if (!uf || !cidade) {
                    e.preventDefault();
                    alert('Por favor, selecione o estado e a cidade.');
                    return false;
                }

                atualizarLocalizacao();
                return true;
            });

            
            carregarEstados();
        });
    </script>
}